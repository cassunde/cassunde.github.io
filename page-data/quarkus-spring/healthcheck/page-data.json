{"componentChunkName":"component---src-templates-index-js","path":"/quarkus-spring/healthcheck","result":{"data":{"site":{"meta":{"title":"Cassunde","description":"Cassunde profile and Blog","url":"https://cassunde.github.io","author":"cassunde","twitter":"@MattheusCassund","adsense":""}},"post":{"id":"b65d0496-47b1-58f9-bda9-205aa8d73f04","html":"<h2>Configurando Health Check no Quarkus e Spring Boot</h2>\n<p>Hoje estou anotando aqui como posso fazer para configurar o endpoint de <a href=\"https://microservices.io/patterns/observability/health-check-api.html\">Health Check</a> usando o Spring-boot e o Quarkus.</p>\n<!--more-->\n<h2>O Health Check API</h2>\n<p>Quando trabalhamos com microservices muitas vezes publicamos nossas aplicações dentro de containers docker que por sua vez são publicados em orquestradores, para facilitar nossa vida, sempre que uma aplicação não estiver saudável podemos configurar que esses orquestradores possam tomar alguma ação, que na maioria das vezes será reiniciar o container x vezes até dele ficar saudável.</p>\n<p>Um benefício e que sua aplicação poderá ser testada periodicamente, dessa forma mitigando o problema de ser pego de surpresa com uma aplicação off.</p>\n<h2>Health Check no Spring Boot</h2>\n<p>Para usarmos o Health Check API no spring, precisamos importar uma lib chamada <a href=\"https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html\">Spring Boot Actuator</a>.</p>\n<p>Quais features podemos encontrar nessa lib:</p>\n<ol>\n<li>Auditoria</li>\n<li>Health</li>\n<li>Métricas</li>\n</ol>\n<p>Podemos também escolher em usar essas features via HTTP ou JMX.</p>\n<p><strong>Health</strong></p>\n<p>Essa informação será exposta no endpoint <code class=\"language-text\">/health</code> da sua aplicação, para habilitarmos precisamos configurar basicamente duas chaves no seu <code class=\"language-text\">application.properties</code> </p>\n<ol>\n<li>management.endpoint.health.show-details</li>\n<li>management.endpoint.health.show-components</li>\n</ol>\n<p>Essas chaves podem receber os seguintes valores:</p>\n<table>\n<thead>\n<tr>\n<th>Valor</th>\n<th>Descrição</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>never</td>\n<td>Nunca expor informação</td>\n</tr>\n<tr>\n<td>when-authorized</td>\n<td>Quando restringimos o acesso para alguns usuários</td>\n</tr>\n<tr>\n<td>always</td>\n<td>Exibe informações para todos os usuários</td>\n</tr>\n</tbody>\n</table>\n<p>Valor default e <code class=\"language-text\">never</code></p>\n<p>Resumindo a configuração básica ficaria assim:</p>\n<ul>\n<li>pom.xml</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependencies</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>org.springframework.boot<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>spring-boot-starter-actuator<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependencies</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<ul>\n<li>Gradle</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">dependencies {\n    implementation org.springframework.boot:spring-boot-starter-actuator\n}</code></pre></div>\n<ul>\n<li>properties</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">management.endpoint.health.show-details=always</code></pre></div>\n<p><strong>Indicadores pré-configurados</strong></p>\n<p>Existem vários indicadores pré-configurados no spring aqui está <a href=\"https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html#production-ready-health-indicators\">Lista Completa</a>.</p>\n<p><strong>Customizando</strong></p>\n<p>Para customizar também e bem simples basta implementar a Interface <code class=\"language-text\">HealthIndicator</code> como no exemplo abaixo:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HealthCustomizedOfMyApplication</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">HealthIndicator</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Health</span> <span class=\"token function\">health</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LocalDateTime</span><span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getMinute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">2</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token class-name\">Health</span><span class=\"token punctuation\">.</span><span class=\"token function\">down</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">withDetail</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Horário Errado\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Health</span><span class=\"token punctuation\">.</span><span class=\"token function\">up</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Simplesmente vamos retornar um objeto do tipo <code class=\"language-text\">Health</code> e ele mesmo sabe criar sua própria instância com método statico <code class=\"language-text\">up();</code> ou <code class=\"language-text\">down();</code></p>\n<h2>Health Check no Quarkus</h2>\n<p>O Quarkus segue a especificação <a href=\"https://github.com/eclipse/microprofile-health/\">eclipse/microprofile-health</a> e usa a implementação <a href=\"https://github.com/smallrye/smallrye-health/\">smallrye/smallrye-health</a> </p>\n<p><strong>Health</strong></p>\n<p>Segundo a especificação basicamente as informações de Health Check serão exibidas nos seguindes end-points:</p>\n<table>\n<thead>\n<tr>\n<th>end-point</th>\n<th>Descrição</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code class=\"language-text\">/health/live</code></td>\n<td>A Aplicação está up e rodando</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">/health/ready</code></td>\n<td>Aplicação está pronta para receber requisições</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">/health</code></td>\n<td>Acumula todos os checks disponíveis.</td>\n</tr>\n</tbody>\n</table>\n<p>Para habilitarmos não precisa configurar nada no properties bastando apenas importar a seguinte dependência:</p>\n<ul>\n<li>POM.xml</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>io.quarkus<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>quarkus-smallrye-health<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<ul>\n<li>inicia aplicação com:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ ./mvnw quarkus:dev</code></pre></div>\n<ul>\n<li>Testa o seguinte end-point</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">curl --request GET --url http://localhost:8080/health/live</code></pre></div>\n<ul>\n<li>sua resposta será algo do tipo:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"status\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"UP\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Para personalizar um <strong>Health Check</strong> e bem simples basta:</p>\n<ul>\n<li>Implementar a interface <code class=\"language-text\">HealthCheck</code> e retornar um objeto do tipo <code class=\"language-text\">HealthCheckResponse</code> .</li>\n<li>Anotar classe com <code class=\"language-text\">@ApplicationScoped</code> para deixar essa classe com escopo de aplicação.</li>\n<li>Anotar classe com qualifier <code class=\"language-text\">@Liveness</code> para informar que essa classe será usada dentro da estrutura de <strong>Health</strong>.</li>\n</ul>\n<p>Exemplo:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Liveness</span>\n<span class=\"token annotation punctuation\">@ApplicationScoped</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HealthCustomizedOfMyApplication</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">HealthCheck</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">HealthCheckResponse</span> <span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LocalDateTime</span><span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getMinute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">2</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token class-name\">HealthCheckResponse</span><span class=\"token punctuation\">.</span><span class=\"token function\">down</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Horário Errado\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">HealthCheckResponse</span><span class=\"token punctuation\">.</span><span class=\"token function\">up</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"HealthCustomizedOfMyApplication\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Com essa configuração retornaria uma resposta assim:</p>\n<ul>\n<li>Request</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">curl --request GET --url http://localhost:8080/health/live</code></pre></div>\n<ul>\n<li>Response</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"status\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"DOWN\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"checks\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Horário Errado\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"status\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"DOWN\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Projeto de exemplo</p>\n<p><a href=\"https://github.com/cassunde/spring_boot_quarkus/blob/master/health/readme.md\">cassunde/spring<em>boot</em>quarkus · GitHub</a></p>","frontmatter":{"layout":"post","title":"Quarkus & Spring Boot - Health Check API","path":"/quarkus-spring/healthcheck","category":"Java","tags":["Arquitetura","Design"],"description":"","date":"2020/05/30","image":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAGABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFgEBAQEAAAAAAAAAAAAAAAAAAQAC/9oADAMBAAIQAxAAAAHbBuiP/8QAFxAAAwEAAAAAAAAAAAAAAAAAARESIv/aAAgBAQABBQLVCkGv/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFxAAAwEAAAAAAAAAAAAAAAAAAAEQQf/aAAgBAQAGPwJmT//EABkQAAMBAQEAAAAAAAAAAAAAAAABESExQf/aAAgBAQABPyFehQ0b0zPWrD//2gAMAwEAAgADAAAAEIAv/8QAFxEBAAMAAAAAAAAAAAAAAAAAAAEx4f/aAAgBAwEBPxDE2//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABoQAQADAQEBAAAAAAAAAAAAAAEAETFRIWH/2gAIAQEAAT8QCTEAe/ZQqmG9hNpoveT/2Q==","aspectRatio":3.2510822510822512,"src":"/static/a2cebac1466d4833c9f4257a784832ec/0f3a1/banner-main.jpg","srcSet":"/static/a2cebac1466d4833c9f4257a784832ec/1ada3/banner-main.jpg 125w,\n/static/a2cebac1466d4833c9f4257a784832ec/8f7df/banner-main.jpg 250w,\n/static/a2cebac1466d4833c9f4257a784832ec/0f3a1/banner-main.jpg 500w,\n/static/a2cebac1466d4833c9f4257a784832ec/f9913/banner-main.jpg 750w,\n/static/a2cebac1466d4833c9f4257a784832ec/e2709/banner-main.jpg 751w","sizes":"(max-width: 500px) 100vw, 500px"}}}}}},"pageContext":{}}}